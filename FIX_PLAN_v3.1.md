# 紧急修复计划 v3.1

## 🚨 发现的严重问题

### 1. 数据源分离（最严重）
```javascript
// 错误：从静态配置读取
getDayTask(ability.name, ability.currentDay)  // config.js
CONFIG.TOTAL_DAYS  // 固定21天

// 正确：应该从ability.path读取
ability.path.chapters  // 动态数据
ability.totalDays  // 用户可调整
```

### 2. 其他问题
- 辅导UI缺少方案对比视图
- AI只改天数，不改任务节点
- 缺少计划选择器
- 删除按钮位置不对

---

## 🔧 修复方案

### 修复1：统一数据源 ✅ **最优先**

**原理：**
- **总表**：`this.abilities` 数组
- **子数据**：所有页面从 `ability.path` 和 `ability.totalDays` 读取
- **修改后**：立即保存到总表，触发全局刷新

**需要修改的方法：**
1. `loadTaskPage()` - 从 `ability.path` 读取任务
2. `renderTimeline()` - 使用 `ability.totalDays`
3. `createAbilityCard()` - 使用 `ability.totalDays`
4. 所有相关方法

### 修复2：重新设计辅导UI

**新布局：**
```
┌──────────────────────────────────────┐
│  辅导记录  [新建辅导] [删除选中]      │  ← 独立横栏
├──────────────────────────────────────┤
│ □ 2024-10-23  讨论了学习进度...       │
│ □ 2024-10-22  调整了方案...           │
└──────────────────────────────────────┘

进入对话后：

┌───────────────┬──────────────┬────────────────┐
│  当前方案      │  新方案预览   │   对话区域      │
│               │  (可选)      │                │
│  21天         │  40天        │   AI: ...      │
│  阶段1...     │  阶段1...    │                │
│  阶段2...     │  阶段2...    │   [确认新方案]  │
└───────────────┴──────────────┴────────────────┘
```

### 修复3：改进AI能力

**新提示词：**
```
任务：调整方案（天数 + 任务节点）

[PROPOSE_PLAN]{
  "totalDays": 40,
  "phases": [
    {
      "name": "基础夯实",
      "days": 15,
      "tasks": ["新任务1", "新任务2", "新任务3"]  ← 可修改
    }
  ]
}[/PROPOSE_PLAN]
```

### 修复4：多计划选择器

**流程：**
```
用户："我想调整计划"
  ↓
AI："你有2个进行中的计划：
     1. 情绪管理能力
     2. 时间管理能力
     请告诉我要调整哪个？"
  ↓
用户："第1个"
  ↓
AI：继续调整流程
```

---

## 📝 实施步骤

### Step 1: 修复数据源（核心）
1. 重写 `loadTaskPage()` - 从 `ability.path` 读取
2. 重写 `renderTimeline()` - 使用 `ability.totalDays`
3. 确保所有卡片从总表读取

### Step 2: 重新设计辅导UI
1. 辅导记录列表移到外层
2. 添加删除按钮到列表
3. 添加方案对比视图（三栏）

### Step 3: 增强AI能力
1. 更新提示词支持任务节点修改
2. 添加多计划识别逻辑
3. 添加计划选择流程

### Step 4: 测试验证
1. 修改方案后检查所有页面
2. 验证数据持久性
3. 测试多计划场景

---

## 🎯 预期效果

### 修复后：
```
辅导页面修改：40天
  ↓
保存到：ability.totalDays = 40
  ↓
刷新所有视图：refreshAllViews()
  ↓
主页显示：第3天 / 40天  ✅
任务页显示：第3天 / 40天  ✅
时间轴显示：40个点  ✅
个人中心：第3天 / 40天  ✅
```

---

## 开始实施

现在开始修复...


